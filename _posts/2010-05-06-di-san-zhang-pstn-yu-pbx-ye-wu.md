---
layout: post
title: "第三章 PSTN 与 PBX 业务 "
---

# {{ page.title }}


在继续学习 FreeSWITCH 之前，我们有必要了解一下传统的电话网所能提供的服务。这些服务有的是你已经熟悉的，有的也可能没听说过。有一些业务在 VoIP 中实现起来就异常简单，而有一些业务已经不需要了。

## PSTN 业务

### POTS

除为用户提供基本的话音通话外，PSTN 还能提供一些附加的业务，这些业务在国外称为普通老式电话业务（POTS，Plain Old Telephone Service），而在国内，我们称之为新业务，当然，这还是沿用数前的叫法。这些业务有的是收费的，有的是不收费的，而这些新业务号码通常以 \* 开头。古老的话机是转盘式的（就是电影上蒋介石用的那种话机），使用脉冲方式拨号，只能拨0～9的号码，现在在民间已极少再使用。现在的话机多为按键式，使双音频方式拨号，有0～9及\*和#字键。其中，\*字键通常读作“星”，但有些运营商的话务员读作“米”。另外有的话机上有A、B、C、D键，很少用到。在某些新业务中（如三方通话），会用到话机上的叉簧，快速拍一下以给交换机传递信号，某些话机上有 Flash 键或 R 键或闪断键能实现相同的功能。下面仅列举几种典型的业务：

* 缩位拨号。通过事先登记的代码拨叫长号码，如 \*\*1 则可以拨叫指定的 12345678

* 呼叫转移。基本的有三种：无条件转移，即任何来电转移至事先登记的号码；遇忙转移，若被叫忙，则转移；无应答转移，若指定时间内无应答，则转移。其中无条件转移的登记方式为 *\*57\*电话号码#*，取消方式为 *#57#*。登记成功后，所有到该话机的来电会转到所登记的电话号码。如在话机A上操作 *\*57\*B#，则所有对A的呼叫都会转移到B上。适用于将家里或办公室电话转移到手机上的情况。运营商也经常使用该功能作一些特殊的业务，如改号通知。他们通过后台操作将某一号码转移至特定的语音平台，则可以实现“您拨的电话已改号，新的号码是XXX”的功能。

* 立即热线。拿机电话不用拨号即自动拨打某号码，如某些银行的自助服务等。还有一类似的功能叫延迟热线。

* 呼叫等待。被叫忙时，主叫仍听正常的回铃音（或个性化的语音提示：请不要挂机，您拨打的电话正在通话中...），而交换机会通过特殊的提示音提示有新电话呼入，被叫可选择是否接听，或在两者间切换。

* 三方通话。通过比较复杂的操作实现三方通话，某些交换机支持最多5方的多方通话（会议电话）。

* 来电显示。                                                 

### 商务业务

运营商的大部分收入还是来自于商务业务。

#### 模拟中继线

模拟中继线又称为用户小交换机，它主要提供号码连选功能。典型应用是提供一个总机号（又称引示号）及若干条中继线。当有人拨号总机号时，交换机会根据指定的策略选择一条空闲的中继线呼入。而用户端通常会接PBX设备，下设分机。当用户呼出时，通过用户端的PBX设备选择一条空闲的线路，用户可选择是否显示总机号。

#### 数字中继线

如果用户需要的中线继数量较多时，数字中继线能提供更稳定的服务，设备通常支持2M的一号信令或30B+D的ISDN信令。

#### 虚拟网     

虚拟网又称商务组（BCG，Business Call Group）或汇线通（Centrex）业务。虚拟网主要提供在无需用户端PBX设备的情况下，实现网内（组）电话互拨小号，通常小号间的通话是免费的，但要比普通电话多收月租费。

#### 立即计费

传统的PSTN需要通过额外的系统来计算通话费用，通常需要有一段时间的滞后。而立即计费主要用于酒店等需要立即计费的场合。



#### VPN

VPN(Virtual Private Network)的全称是虚拟专用网，有别于Internet上的VPN。它主要是用在连接大型企业在不同城市的分支机构，实现公司内部互拨小号。

### 其它增值业务

传统的语音业务所带来的收入比例越来越低，因此，各大运营商都纷纷推出基于数据库和计算机系统的各种增值业务以扩大收入。这些业务包括预付费业务（电话卡类业务等），800、400业务以及彩铃、电话秘书台（语音信箱）等。


## PBX 业务


PBX（Private Branch eXchange）的全称是专用小交换机。企业使用 PBX 的好处是可以自己控制内部呼叫，而且内部通话免费。它通常可以提供呼叫保持、自动选线、呼叫转移、呼叫转接等基本功能，比较高级的小交换机还可以提供自动总机、三方通话、语音信箱等。

PBX 的上端通过模拟或数字中继线连接到PSTN，而下端则直接接话机。


#### 中继线                  
由于 FreeSWITCH 缺省配置可以用作一个PBX，深入理解PBX是非常必要的。下面，我们以模拟中继线为例，通过一则故事进行说明。

TODO（图）。

我们刚开了一个公司，需要 7 部电话，于是申请了 7 条模拟中继线。上文已经指出，实际上就是 7 条普通的电话线，只是在 PSTN 交换机端有特殊的数据设置，将其逻辑上分为一个组，并为该组设一个总机号。我们有幸选到了一个很酷的号码 --  88888888（它可以是一个虚拟的号码，或者是其中某一条中继线的号码）。而其它的中继线号则可能是，44440001 ～ 44440007。现在，我们把这 7 条线都接上话机。如果有人呼叫 88888888，则 PSTN 交换机会从 7 条线中选择一条空闲的线呼入，因此某个电话会振铃。一般来说，交换机有两种选线策略──顺序选线和循环选线。所谓顺序选，就是每次都从 44440001 开始，寻找一条空闲的线路进行呼入；而循环选则是每次都从上一次呼叫的下一个开始选起，使用这种选线方式，每个话机接到的电话数会比较平均。
        
为了维护企业形象，当有人呼出时，不管是从哪个分机呼出，都显示总机号 88888888. 当然，也可以显示单线的号码（如44440004），这个要在 PSTN 交换机端设置，一旦设置后，用户端不能动态更改。

一个月后，公司发展到 21 个人，因此，需要 21 部电话。但由于不会所有人同时打电话，因此我们买了一个小交换机。把原来的 7 条中线线接到小交换机上，而每个人都有一个分机号，从 601 到 621 。当客户打总机号时， PSTN 仍然会选择一条线进入小交换机，这时候，选线方式已经不像以前那样重要，因为现在是小交换机在接电话，对它来说， 7 条线哪条都一样。就这样，小交换机接了电话，并播放“您好，欢迎致电XX公司，请直拨分机号，查号请拨 0 ”，如果客户按某一分机号，则对应分机振铃，电话接通。

有了小交换机，内部通话就免费了。但增加了另外一个问题，就是如果拨打外线，则需要先拨一个特殊的数字，一般是 0 或 9 。有的小交换机会送二次拨号音，即你拿起电话，听小交换机的拨号音，拨了 0 之后，则听到 PSTN 交换机的拨号音，证明你是要拨打外线了。总之，小交换机会选择一条中继线对外呼叫。

其中，21 : 7 称为集线比。即 3 比 1 。集线比是由话务量决定的，如果同时通话的人数比较多，那我们可能考虑把中继线增加到12条，集线比就降为 2 比 1。

即使增加了线路，也经常会遇到这样的情况，由于打进来的电话太多，占用了太多的线路，经常一个电话都打不出，因此，我们联系电信部门，将中继线分为两组，其中4条只进不出，4条只出不进，4条能出能进。在电信术语中，分别叫做单出，单入和双向，而北京则称发专、受专和双向，需要指出，对电信部门来说，出和入跟我们是相反的，因为我们（小交换机）的出，则上他们（PSTN 交换机）的入。当然，这种分配方式降低了总体线路的使用率，为此，我们把每个都增加到5条，总共15条。

又过了几天，有客户反映这样的情况，打电话经常无人接听，需要打好几遍；而同时，内部也有人反映往外打电话时有时拨 0 没反应，再试一次就好了。最直接判断是某条线断了，因为，如果有一条线断了，交换机仍会向对方送回铃音，跟没人接听一样。但到底是哪条线断了，却不好查。因为双方都是自动选线。当然，最直接的办法是将每条线都从小交换机上拨下来，接上话机试一试。某些小交换机也支持指定端口拨打功能，即在拨打真正号码前先拨几个特殊的数字可以选择从指定的线路出去。实际上还有一种方法。一般来说，每条单线的号码也都是可以呼入的，只是外人不知道而已。只需要依次拨打所有的单线号码就可以知道哪条线是断了。当然，这依赖于交换机的设置，有些城市默认设置单线是不允许呼入的。

几天后，老板又通过关系搞到了一个新号码 66666666 ，该号码并未加入中继线组，而是直接到老板办公桌上。但为了拨打内线，他不得不把办公桌上放两部电话，另一部专门打内线。后来技术人员小张仔细阅读了说明书，发现该小交换机功能还比较强，就进行了以下设置。将 66666666 这个号码接到小交换机上，进行特殊设置，只有老板打出时才走这个端口；而对于打入的电话，也不播放“欢迎致电XX公司…”，而是直接向老板电话振铃。这种拨入方式叫做 DID，即对内直接呼叫（Direct Inbound Dial）。

接下来，随着公司的发展，加入的中继线条数越来越多，而维护起来更加麻烦，因为，如果其中有一条线断了，在很长的一段时间内你根本不知道，即使知道了，要找到那条线也非常麻烦。后来，当公司发展到 100 人的时候，公司终于购买了新设备，并将中继线换成了两条 E1 数字线路，可同时支持 60 路电话。

公司发展一帆风顺，电话量也越来越多，公司有了很多分支机构，也有了更多客户，需要更复杂的语音菜单及更智能的分配策略，而更换专门的电话系统不仅价格昂贵，而且跟现有业务系统的集成难度很大。在综合考虑了多种解决方案以后，技术人员开始学习 FreeSWITCH ……
