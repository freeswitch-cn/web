---
layout: default
title: "第一章 PSTN 与 VoIP"
---

# {{ page.title }}

说起VoIP，也许大家对网络电话更熟悉一些。其英文原意是Voice Over IP，即承载于IP网上的语音通信。大家熟悉家庭用来上网的ADSL吧，也许有些人还记得前些年用过的吱吱叫的老“猫”。技术日新月异，前面的技术都是用电话线上网，现在，VoIP技术使我们可以在网上打电话，生活就是这样。

所谓温故而知新，在了解任何东西以前，我们都最好了解一下其历史，以做到心中有数。在了解VoIP之前，我们需要先看一下PSTN，那在PSTN之前呢？

## PSTN起源

PSTN(Public Switched Telephone Network)的全称是公共交换电话网，就是我们现在打电话所使用的电话网络。

第一次语音传输是亚历山大·贝尔(Alexander Granham Bell)在1876年用振铃电路实现的。在那之前，普遍认为烽火台是最早的远程通信方式。其实峰火台不仅具备通信的完整要素(通信双方，通信线路及中继器)，而且还是无线通信。当时的没有电话号码，相互通话的用户之间必须有物理线路连接；并且，在同一时间只有一个用户可以讲话(半双工)。发话方通过话音的振动激励电炭精麦克风而转换成电信号，电信号传到远端后通过振动对方的扬声器发声，从而传到对方的耳朵里。
                      
由于每对通话的个体之间都需要单独的物理线路，如果整个电话网上有10个人，而你想要与另个9个人通话，你家就需要铺设9对电话线。同时整个电话网上就需要 *10 x (10-1) / 2 = 45* 对电话线。

当电话用户数量增加的时候，为每对通话的家庭之间铺设电话线是不可能的。因此一种称为交换机（Switch）的设备诞生了。它位于整个电话网的中间用于连接每个用户，用户想打电话时先拿起电话连接到管理交换机的接线员，由接线员负责接通到对方的线路。这便是最早的电话交换网。

由于技术的进步，电子交换机替代了人工交换机，便出现了现代意义的PSTN。随着通信网络的进一步扩大，便出现了许许多多的交换机。交换机间通过中继线（Trunk）相连。有时一个用户与另一个用户通话需要穿越多台交换机。

后来出现了移动电话（当移动电话小到可以拿在手里的时候就开始叫“手机”），专门用于对移动电话进行交换的通信网络称移动网，而原来的程控交换网则叫固定电话网，简称固网。简单来说，移动网就是在普通固网的基础上增加了许多基站（Base Station，可以简单理解为天线），并增加了归属位置寄存器（HLR，Home Location Register）和拜访位置寄存器（VLR，Visitor Location Register），以用户记录用户的位置（在哪个天线的覆盖范围内）、支持异地漫游等。移动交换中心称之为MSC（Mobile Switch Center）。

模拟与数字信号
----

现实中的一切都是模拟的。模拟量（Analog）是连续的变化的，如温度、声音等。早期的电话网是基于模拟交换的。模拟信号对于人类交流来讲非常理想，但它很容易引入噪声。如果通话双方距离很远的话，由于信号的衰减，需要对信号进行放大。问题是信号中经常混入线路的噪音，放大信号的同时也放大的噪音，导致信噪比（信号量与噪声的比例）下降，严重时会难以分辨。

数字（Digital）信号是不连续的（离散的）。它是按一定的时间间隔（单位时间内抽样的次数称为频率）对模拟信号进行抽样得出的一些离散值。根据[抽样定理][]，当抽样频率是最高模拟信号频率的两倍时，就能够完全还原原来的模拟信号。
                                                                     
[抽样定理]: http://zh.wikipedia.org/wiki/采样定理 "又称采样定理或奈奎斯特·香农定理"

PCM
----

PCM（Pulse Code Modulattion）的全称是脉冲编码调制。它是一种通用的将模拟信号转换成以0和1表示的数字信号的方法。

一般来说，人的声音频率范围在 *300Hz ~ 3400Hz* 之间， 通过滤波器对超过 *4000Hz* 的频率过滤出去，便得到 *4000Hz* 内的模拟信号。然后根据抽样定理，使用 *8000Hz* 进行抽样，便得到离散的数字信号。

通过使用压缩算法（实际为压扩法，因为有的部分压缩有的是扩张的。目的是给小信号更多的比特位数以提高语音质量），可以将每一个抽样值压缩到8个比特。这样就得到 *8 x 8000 = 64000bit* （通常称为64kbit/s。注意，通常来说，对于二进制数，1kbit=1024bit，但此处的k=1000）的信号。通常我们就简称为64k。

PCM通常有两种压缩方式：A律和μ律。其中北美使用μ律，我国和欧洲使用A律。这两种压缩方法很相似，都采用8bit的编码获得12bit到13bit的语音质量。但在低信噪比的情况下，μ律比A律略好。

我国电话网结构
----

<img src="http://commondatastorage.googleapis.com/freeswitch.org.cn/images/1-1.png"/>

图中主体部分为一地市级电话网的结构。通常，话机（如c）通过一对电话线连接到距离最近的交换机上，该交换机称为端局交换机（一般以区或县为单位）。端局交换机通过局间中继线连接到汇接局。为了保证安全，汇接局通常会成对出现，平常实行负荷分担，一台汇接局出现故障时与之配对的汇接局承担所有话务。长途电话需要通过长途局与其它长途局相连。但根据话务量要求，汇接局也可以直接与其它长途局开通高速直达中继。为节省用户线，在一些人口比较集中的地方（如学校、小区），端局下会再设模块局或接入网，用户则就近接入的模块局上。

智能网一般用于实现电话卡、预付费或400/800类业务，而近几年新布署的NGN（Next Generation Network，下一代网络，一般指软交换。）则支持更灵活、更复杂的业务。


时分复用与局间中继
----

### 时分复用
通过将多个信道以时分复用的方式合并到一条电路上，可以减少局间中继线的数量。通过将32个64k的信道利用时分复用合并到一条2M（ *64k x 32 = 2.048M* ，通俗来说就直接叫一个2M）电路上，称为一个E1（在北美和日本，是24个64k复用，称为T1，速率是1.544M）。在E1中，每一个信道称作一个时隙。其中，除0时隙固定传同步时钟，其它31个时隙最多可以同时支持31路电话（如果使用隨路信令，则使用第16时隙传送，这时最多支持30路电话）。

### 局间中继
这些连接交换机(局)的2M电路就称为局间中继。随着话务量的增加，交换机之间的电路越开越多，目前通常的做法是将63个2M合并到一个155M（ *2 x 63 + P = 155*，其中P是电路复用的开销）的光路（光纤）上。

信令
----
用户设备（如话机）与端局交换机之间，以及交换机与交换机之间需要进行通信。这些通信所包含的信息包括（但不限于）用户、中继线状态，主、被叫号码，中继路由的选择等。我们把这些消息称为信令（Signaling）。

### 用户线信令
用户线信令是从用户话机到端局交换机之间传送的信令。对于普通的话机，线路上传送的是模拟信号，信令只能在电话线路上传送，这种信令称为带内信令。话机通过电压变化来传递摘、挂机信号；通过DTMF（Dual Tone Multi Frequency，双音多频。话机上每个数字或字母都可以发送一个低频和一个高频信号相结合的正弦波，交换机经过解码即可知道对应的话机按键）传送要拨叫的电话号码。另外，也可以通过移频键控（FSK,Frequency Shift-keying）技术支持来电显示（Caller ID或CLIP，Caller Line Identification Presentation，主叫线路识别提示）。

与普通电话不同，ISDN（Integrated Service Digital Network，综合业务数字网）在用户线上传送的是数字信号。它的基本速率接口使用144k的2B+D信道--两个64k的B信道及一个16k的D信道。由于其信令在话路（B信道）以外的D信道传送，这种信令称为带外信令。

实际上，2B+D的ISDN并没有发挥出它应有的作用，在国内已很少有人使用。

### 局间信令
局间信令主要在局间中继上传送。一般一条信令链路通常只占用一个64k的时隙。一条信令消息通常只有几十或上百个字节，一条64k的电路足矣容纳成千上万路电话所需要的信令。但随着技术的进步，话务量的上涨以及更多增值业务的出现，完成一次通话需要更多的信令消息，因此出现了2M速率的信令链路，即整个E1链路上全部传送信令。

局间信令也分为带内信令和带外信令。带内信令又称为随路信令，它是在跟话路同一个2M上传送的，通常使用第16时隙。带外信令则是在独立的专门用于传送信令链路的2M中继上传送的，与带内信令相比，它更加灵活。我国的电话网络中有专门的信令网并使用7号信令（SS7, Signaling System No. 7）。

### 七号信令
SS7是目前我国使用的主要的信令方式
     
	用户A          a交换机        b交换机         用户B
       |             |             |             |
       |   摘机              
       |------------>|             |             |
       |   拨号音              
       |<------------|             |             |
       |   拨号            IAM          振铃    
       |------------>|------------>|------------>|
       |   回铃音           ACM      
       |<------------|<------------|             |
       |   通话            ANM           接听
       |<------------|<------------|<------------|
       |   ...       |             |             |
       |   ...       |             |             |
       |   挂机            REL           送催挂音   
       |------------>|------------>|------------>|
       |                  RLC
       |             |<------------|<------------| 
       |             |             |             |

我们来看一次简单的固定电话的通话流程。如图。用户A摘机，与其相连的a交换机根据电压变化检测到A摘机后，即送拨号音，同时启动收号程序。A开始拨号，待a交换机号码收齐后，即查找路由，发送IAM（初始地址消息）给b交换机。b向话机B振铃，同时向a发ACM（地址全消息），a向A送回铃音。这时如果B接听电话，则b向a发送ANM（应答计费消息），A与B开始通话，同时a对A计费。通话完毕，任何一方挂机，则本端交换机（如a）向对端b发送REL（释放消息），b向a回RLC（确认，释放完成），并向B送催挂音（啫啫啫...）。

上面在交换机a与b之间传递的为七号信令中的TUP（Telephone User Part，电话用户部分）部分。目前，由于ISUP（ISDN User Part，ISDN用户部分）能与ISDN互联并提供比TUP更多的能力和服务，已基本取代TUP而成为我国七号信令网上主要的信令方式。
                                                                                
## 电路交换与分组交换

Todo.

## VoIP

维基百科上是这样说的:

IP电话(简称VoIP，源自英语Voice over Internet Protocol；又名宽带电话或网络电话)是一种透过互联网或其他使用IP技术的网络，来实现新型的电话通讯。过去IP电话主要应用在大型公司的内联网内，技术人员可以复用同一个网络提供数据及语音服务，除了简化管理，更可提高生产力。随着互联网日渐普及，以及跨境通讯数量大幅飙升，IP电话亦被应用在长途电话业务上。由于世界各主要大城市的通信公司竞争日剧，以及各国电信相关法令松绑，IP电话也开始应用于固网通信，其低通话成本、低建设成本、易扩充性及日渐优良化的通话质量等主要特点，被目前国际电信企业看成是传统电信业务的有力竞争者。详细内容参见[维基百科上的 IP 电话](http://zh.wikipedia.org/wiki/IP电话)。 

目前，VoIP呼叫控制协议主要有SIP、H323，以及MGCP与H.248/MEGACO等。H323是由ITU-T（国际电信联盟）定义的多媒体信息如何在分组交换网络上承载的建议书。它是一个相当复杂的协议，使用起来很不灵活。而SIP则是IETF（互联网工程任务组）开发的（RFC3261），它是一种类似HTTP的基于文本的协议，很容易实现和扩展，被普遍认为是VoIP信令的未来。

